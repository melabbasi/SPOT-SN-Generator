<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPOT Serial Number Generator</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom error styling */
    #result.error {
      border-color: #ef4444; /* red-500 */
      color: #ef4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Smooth focus ring */
    .focus-ring {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen flex items-center justify-center p-4">

  <!-- Main Application Card -->
  <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-200">
    
    <!-- Logo -->
    <div class="flex justify-center mb-5">
      <img src="logo.png" alt="SPOT Logo" class="h-16 w-auto object-contain" onerror="this.classList.add('hidden')" />
    </div>

    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
      SPOT Serial Number Generator
    </h1>

    <!-- Form Grid -->
    <div class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-5 items-center">
      <!-- 1. Event Year -->
      <label for="year" class="text-sm font-medium text-gray-700 text-right">1. Event Year:</label>
      <input type="number" id="year" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />

      <!-- 2. Event Type -->
      <label for="eventType" class="text-sm font-medium text-gray-700 text-right">2. Event Type:</label>
      <select id="eventType" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <!-- Filled by JS -->
      </select>

      <!-- 3. Event Number -->
      <label for="eventNum" class="text-sm font-medium text-gray-700 text-right">3. Event Number:</label>
      <input type="number" id="eventNum" value="1" min="1" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />

      <!-- 4. Participation Type -->
      <label for="partType" class="text-sm font-medium text-gray-700 text-right">4. Participation:</label>
      <select id="partType" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <!-- Filled by JS -->
      </select>

      <!-- 5. Serial Number -->
      <label for="serial" class="text-sm font-medium text-gray-700 text-right">5. Serial Number:</label>
      <input type="number" id="serial" value="1" min="1" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
    </div>

    <!-- Generate Button -->
    <button id="generateButton" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 px-4 rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md hover:shadow-lg">
      Generate Serial Number
    </button>

    <!-- Result Display -->
    <input type="text" id="result" readonly class="w-full mt-5 bg-gray-50 text-gray-900 font-mono text-lg text-center py-3 px-4 border-2 border-gray-300 rounded-xl transition focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />

    <!-- Error Message -->
    <p id="error-message" class="text-red-600 text-center text-sm h-5 mt-1"></p>

    <!-- Copy Button -->
    <button id="copyButton" class="w-full mt-3 bg-gradient-to-r from-gray-700 to-gray-800 text-white font-semibold py-3 px-4 rounded-xl hover:from-gray-800 hover:to-black focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md hover:shadow-lg">
      Copy to Clipboard
    </button>

    <a href="Certificate_Rules.pdf" target="_blank" class="block w-full mt-3">
    <button class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold py-3 px-4 rounded-xl hover:from-green-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md hover:shadow-lg">
      قواعد إنشاء الشهادات (PDF)
    </button>
    </a>
    <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
        </div>
        <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-white text-gray-500">Bulk Mode (Excel)</span>
        </div>
    </div>

    <div class="space-y-3">
        <label class="block text-sm font-medium text-gray-700 text-center mb-1">Upload Names List (No Headers)</label>
        <input type="file" id="uploadExcel" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
        
        <button id="processExcelBtn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold py-3 px-4 rounded-xl hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md hover:shadow-lg">
            Generate & Download
        </button>
    </div>

    <!-- Copyright Footer -->
    <div class="mt-8 text-center text-gray-500 text-sm">
      © El-Abbasi
    </div>
  </div>

  <!-- JavaScript Logic -->
  <script>
    // --- Data Mappings ---
    const EVENT_TYPES = {
      "BLS": "1",
      "Soft Skills": "2",
      "Intern": "3",
      "Pre-internal": "4",
      "ALS": "4",
      "Fracture workshop": "5",
      "Organizational workshop": "6",
      "POT or TOT": "7",
      "Psychiatry": "8",
      "Orientation": "9",
      "Seminar": "0",
      "Campaign \"AIC\"": "11",
      "Computer or Language course": "12"
    };

    const PARTICIPATION_TYPES = {
      "Audience": "1",
      "LC": "2",
      "HR Representative": "11",
      "PR Representative": "12",
      "Media Representative": "13",
      "Trainer": "3",
      "Co-trainer": "4",
      "Organization": "5",
      "Facilitator or Instructor": "6",
      "Certificate of Honor": "7"
    };

    document.addEventListener("DOMContentLoaded", () => {
      const yearEl = document.getElementById("year");
      const eventTypeEl = document.getElementById("eventType");
      const eventNumEl = document.getElementById("eventNum");
      const partTypeEl = document.getElementById("partType");
      const serialEl = document.getElementById("serial");
      const generateBtn = document.getElementById("generateButton");
      const resultEl = document.getElementById("result");
      const copyBtn = document.getElementById("copyButton");
      const errorEl = document.getElementById("error-message");

      // Set current year
      yearEl.value = new Date().getFullYear();

      // Populate dropdowns
      for (const [name, code] of Object.entries(EVENT_TYPES)) {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = name;
        eventTypeEl.appendChild(option);
      }

      for (const [name, code] of Object.entries(PARTICIPATION_TYPES)) {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = name;
        partTypeEl.appendChild(option);
      }

      // Event listeners
      generateBtn.addEventListener("click", generateSerial);
      copyBtn.addEventListener("click", copyToClipboard);

      function generateSerial() {
        errorEl.textContent = "";
        resultEl.value = "";
        resultEl.classList.remove("error");

        try {
          const yearStr = yearEl.value.trim();
          if (!/^\d{2,}$/.test(yearStr)) throw new Error("Invalid Year. Must be at least 2 digits.");
          const yearCode = yearStr.slice(-2);

          const eventCode = eventTypeEl.value;
          if (!eventCode) throw new Error("Please select an Event Type.");

          const eventNumStr = eventNumEl.value.trim();
          if (!/^\d+$/.test(eventNumStr) || parseInt(eventNumStr) < 1) throw new Error("Invalid Event Number.");
          const eventNumCode = eventNumStr;

          const partCode = partTypeEl.value;
          if (!partCode) throw new Error("Please select a Participation Type.");

          const serialStr = serialEl.value.trim();
          if (!/^\d+$/.test(serialStr) || parseInt(serialStr) < 1) throw new Error("Invalid Serial Number.");
          const serialCode = serialStr.padStart(3, '0');

          const finalSerial = `${yearCode}${eventCode}${eventNumCode}${partCode}${serialCode}`;
          resultEl.value = finalSerial;
        } catch (e) {
          errorEl.textContent = e.message;
          resultEl.classList.add("error");
        }
      }

      function copyToClipboard() {
        const serial = resultEl.value;
        if (!serial || resultEl.classList.contains("error")) return;

        navigator.clipboard?.writeText(serial).then(() => {
          const original = copyBtn.textContent;
          copyBtn.textContent = "Copied!";
          setTimeout(() => copyBtn.textContent = original, 2000);
        }).catch(() => {
          // Fallback
          const temp = document.createElement('textarea');
          temp.value = serial;
          document.body.appendChild(temp);
          temp.select();
          document.execCommand('copy');
          document.body.removeChild(temp);
          errorEl.textContent = "Copied manually.";
          setTimeout(() => errorEl.textContent = "", 2000);
        });
      }
    });
    // --- Bulk Excel Logic (Updated Filename) ---
      const processBtn = document.getElementById("processExcelBtn");
      const fileInput = document.getElementById("uploadExcel");

      processBtn.addEventListener("click", () => {
        const file = fileInput.files[0];
        if (!file) {
          alert("Please upload an Excel file first!");
          return;
        }

        // تعريف العناصر (Inputs)
        const yearEl = document.getElementById("year");
        const eventTypeEl = document.getElementById("eventType");
        const eventNumEl = document.getElementById("eventNum");
        const partTypeEl = document.getElementById("partType");
        const serialEl = document.getElementById("serial");

        let baseCodePrefix = "";
        let startSerialInt = 1;
        let fileName = "Attendance.xlsx"; // Default

        try {
          const yearStr = yearEl.value.trim();
          if (!/^\d{2,}$/.test(yearStr)) throw new Error("Invalid Year.");
          const yearCode = yearStr.slice(-2);

          const eventCode = eventTypeEl.value;
          if (!eventCode) throw new Error("Select Event Type.");

          const eventNumStr = eventNumEl.value.trim();
          if (!/^\d+$/.test(eventNumStr)) throw new Error("Invalid Event Num.");
          
          const partCode = partTypeEl.value;
          if (!partCode) throw new Error("Select Participation.");

          const serialStr = serialEl.value.trim();
          if (!/^\d+$/.test(serialStr)) throw new Error("Invalid Start Serial.");
          
          startSerialInt = parseInt(serialStr); 
          
          // تكوين الجزء الثابت من الكود
          baseCodePrefix = `${yearCode}${eventCode}${eventNumStr}${partCode}`;

          // --- 1. تجهيز اسم الملف (New Logic) ---
          // سحب النص الظاهر في القائمة بدلاً من القيمة الرقمية
          const eventNameText = eventTypeEl.options[eventTypeEl.selectedIndex].text;
          const partNameText = partTypeEl.options[partTypeEl.selectedIndex].text;
          
          // تنظيف الاسم من أي علامات قد تمنع حفظ الملف (مثل / أو \)
          const safeEventName = eventNameText.replace(/[\/\\?%*:|"<>]/g, '-');
          const safePartName = partNameText.replace(/[\/\\?%*:|"<>]/g, '-');

          // تركيب الاسم: {Participation} - {Event Type} - {Event Number}.xlsx
          // ملاحظة: استخدمت رقم الحدث (Event Number) كمعرف للملف
          fileName = `${safePartName} - ${safeEventName} - ${eventNumStr}.xlsx`;

        } catch (e) {
          alert("Error in Form Data: " + e.message);
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

          const finalData = [];
          finalData.push(["Name", "Serial", "DESC"]);

          let counter = 0;
          jsonData.forEach(row => {
            const name = row[0]; 
            if (name && typeof name === 'string' && name.trim() !== "") {
              const currentSerialNum = startSerialInt + counter;
              const currentSerialStr = currentSerialNum.toString().padStart(3, '0');
              const fullID = `${baseCodePrefix}${currentSerialStr}`;
              finalData.push([name.trim(), fullID, ""]);
              counter++;
            }
          });

          const newWs = XLSX.utils.aoa_to_sheet(finalData);
          const newWb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(newWb, newWs, "Attendance");
          
          // --- 2. الحفظ بالاسم الجديد ---
          XLSX.writeFile(newWb, fileName);
          
          alert(`Done! File saved as: ${fileName}`);
        };
        
        reader.readAsArrayBuffer(file);
      });
  </script>
</body>

</html>
