<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPOT Certificate Eligibility</title>
  <link rel="icon" type="image/png" href="logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Custom error styling */
    #status.error { color: #ef4444; }
    #status.success { color: #10b981; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-200">
    
    <div class="flex justify-center mb-5">
      <a href=index.html><img src="logo.png" alt="SPOT Logo" class="h-16 w-auto object-contain" onerror="this.style.display='none'" /></a>
    </div>

    <div class="flex justify-center mb-6">
        <a href="team_splitter.html"><img src="teams.png" width="60" height="60" class="mx-4 hover:opacity-80 transition"></a>
        <a href="certificates.html"><img src="certificates.png" width="60" height="60" class="mx-4 hover:opacity-80 transition"></a>
        <a href="https://spot.tanta.edu.eg/ts-admin/dashboard.php"><img src="admin.png" width="60" height="60" class="mx-4 hover:opacity-80 transition"></a>
    </div>

    <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">
      Certificate Eligibility Checker
    </h1>
    <p class="text-center text-gray-500 text-sm mb-8">
      Upload attendance sheets to filter qualified members.
    </p>

    <div class="space-y-4">
        <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
            <label class="block text-sm font-semibold text-blue-800 mb-2">Step 1: Upload Event Files (Excel)</label>
            <input type="file" id="uploadFiles" multiple accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer transition"/>
            <p class="text-xs text-gray-400 mt-2">* Supports multiple files. Headers expected on Row 3.</p>
        </div>

        <button id="analyzeBtn" class="w-full bg-gradient-to-r from-gray-700 to-gray-800 text-white font-semibold py-3 px-4 rounded-xl hover:from-gray-800 hover:to-black transition duration-200 shadow-md">
            Analyze Files & Detect Roles
        </button>
    </div>

    <div id="rulesArea" class="hidden mt-6 animate-fade-in">
        <div class="relative my-4">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
            <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500 font-medium">Step 2: Set Rules</span></div>
        </div>

        <p class="text-sm text-center text-gray-600 mb-4">Set minimum sessions required for each role:</p>
        
        <div id="rolesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            </div>

        <button id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 px-4 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition duration-200 shadow-md hover:shadow-lg">
            Generate Eligibility List
        </button>
    </div>

    <p id="status" class="text-center text-sm font-medium mt-4 h-6"></p>

    <div class="mt-8 text-center text-gray-500 text-sm border-t pt-4">
      © El-Abbasi
    </div>
  </div>

<script>
    let globalData = []; 
    let eventName = "Unknown Event";

    const analyzeBtn = document.getElementById('analyzeBtn');
    const generateBtn = document.getElementById('generateBtn');
    const fileInput = document.getElementById('uploadFiles');
    const rulesArea = document.getElementById('rulesArea');
    const rolesContainer = document.getElementById('rolesContainer');
    const statusEl = document.getElementById('status');

    // دالة لتنظيف وتوحيد أسماء الأعمدة (Smart Header Normalizer)
    function normalizeRowKeys(row) {
        const newRow = {};
        Object.keys(row).forEach(key => {
            // تحويل الاسم لحروف كبيرة وإزالة المسافات الزائدة
            // Example: "  User Id " -> "USER ID" -> "ID" (mapping handled below)
            let cleanKey = key.trim().toUpperCase();
            newRow[cleanKey] = row[key];
        });
        return newRow;
    }

    analyzeBtn.addEventListener('click', async () => {
        const files = fileInput.files;
        if (files.length === 0) {
            showStatus("Please select at least one file.", "error");
            return;
        }

        showStatus("Reading files...", "neutral");
        globalData = [];
        const rolesSet = new Set();
        let missingColumns = [];

        try {
            for (let file of files) {
                const rawData = await readFile(file);
                
                if (rawData.length === 0) continue;

                // فحص أول صف للتأكد من وجود الأعمدة المطلوبة
                const firstRowNormalized = normalizeRowKeys(rawData[0]);
                const requiredCols = ['ID', 'NAME', 'ROLE']; // الأعمدة الإجبارية
                
                // التأكد من وجود الأعمدة
                const missing = requiredCols.filter(col => !Object.keys(firstRowNormalized).includes(col));
                if (missing.length > 0) {
                    throw new Error(`File "${file.name}" is missing columns: ${missing.join(', ')}`);
                }

                rawData.forEach(row => {
                    const normRow = normalizeRowKeys(row);
                    
                    // التأكد ان الصف فيه بيانات مش فاضي
                    if(normRow['ID']) {
                        // تخزين البيانات بالأسماء الموحدة
                        globalData.push({
                            'ID': normRow['ID'],
                            'NAME': normRow['NAME'],
                            'ROLE': normRow['ROLE'] || 'Audience', // Default role if empty
                            'TEAM': normRow['TEAM'] || '-',
                            'SESSION NAME': normRow['SESSION NAME'] || 'Session 1',
                            'EVENT NAME': normRow['EVENT NAME'] || 'Event'
                        });

                        if(normRow['ROLE']) rolesSet.add(normRow['ROLE']);
                        if(normRow['EVENT NAME']) eventName = normRow['EVENT NAME'];
                    }
                });
            }

            if (globalData.length === 0) throw new Error("No valid data found. Check if Excel is empty.");

            // لو مفيش أدوار تم اكتشافها، ضيف دور افتراضي
            if (rolesSet.size === 0) rolesSet.add('Audience');

            renderRoleInputs(Array.from(rolesSet));
            rulesArea.classList.remove('hidden');
            showStatus(`Success! Loaded ${globalData.length} records. Detected roles: ${Array.from(rolesSet).join(', ')}`, "success");

        } catch (e) {
            showStatus(e.message, "error");
            console.error(e);
        }
    });

    generateBtn.addEventListener('click', () => {
        try {
            const rules = {};
            document.querySelectorAll('.role-input').forEach(input => {
                rules[input.dataset.role] = parseInt(input.value) || 0;
            });

            const members = {};

            globalData.forEach(row => {
                const id = row['ID'];
                // توحيد اسم السيشن عشان لو فيه مسافات
                const session = String(row['SESSION NAME']).trim(); 
                
                if (!members[id]) {
                    members[id] = {
                        ID: id,
                        NAME: row['NAME'],
                        TEAM: row['TEAM'],
                        ROLE: row['ROLE'],
                        sessions: new Set()
                    };
                }
                members[id].sessions.add(session);
            });

            const qualified = [];
            
            Object.values(members).forEach(member => {
                const sessionCount = member.sessions.size;
                const required = rules[member.ROLE] || 0;

                if (sessionCount >= required) {
                    qualified.push({
                        "ID": member.ID,
                        "Name": member.NAME,
                        "Team": member.TEAM,
                        "Role": member.ROLE,
                        "Sessions Count": sessionCount,
                        "Sessions List": Array.from(member.sessions).join(", ")
                    });
                }
            });

            if (qualified.length === 0) {
                showStatus("No members met the criteria.", "error");
                return;
            }

            exportToExcel(qualified);

        } catch (e) {
            showStatus("Error: " + e.message, "error");
        }
    });

    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    // range: 0 means Start from Row 1
                    const json = XLSX.utils.sheet_to_json(sheet, {range: 0, defval: ""}); 
                    resolve(json);
                } catch (err) { reject(err); }
            };
            reader.onerror = (err) => reject(err);
            reader.readAsArrayBuffer(file);
        });
    }

    function renderRoleInputs(roles) {
        rolesContainer.innerHTML = '';
        roles.forEach(role => {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200";
            div.innerHTML = `
                <span class="text-sm font-semibold text-gray-700 truncate mr-2" title="${role}">${role}</span>
                <div class="flex items-center">
                    <span class="text-xs text-gray-400 mr-2">Min:</span>
                    <input type="number" value="1" min="0" data-role="${role}" class="role-input w-16 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                </div>
            `;
            rolesContainer.appendChild(div);
        });
    }

    function exportToExcel(data) {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Eligible Members");
        const safeName = String(eventName).replace(/[^a-z0-9]/gi, '_').substring(0, 20);
        XLSX.writeFile(wb, `${safeName}_Qualified_List.xlsx`);
        showStatus(`Success! Downloaded file.`, "success");
    }

    function showStatus(msg, type) {
        statusEl.textContent = msg;
        statusEl.className = "text-center text-sm font-medium mt-4 h-6 " + type;
        if(type === "neutral") statusEl.style.color = "#6b7280";
    }
  </script>
</body>

</html>
